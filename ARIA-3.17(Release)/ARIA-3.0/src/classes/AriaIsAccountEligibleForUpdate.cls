/**********************************************************************
Name:  AriaIsAccountEligibleForUpdate()
Copyright Â© 2012  Aria
============================================================================================================
Purpose:                                                           
-------  
A class that rdetermines if the incoming account from Aria has a valid Master Client Plan. 
If yes then update account details and account plans else exit.
============================================================================================================
History                                                           
-------                                                           
VERSION  AUTHOR                     DATE              DETAIL                       Change Request
   1.0 - Soliant Consulting (AB)    04/17/2012        INITIAL DEVELOPMENT          
 
***********************************************************************/
global with sharing class AriaIsAccountEligibleForUpdate 
{

    AriaConfiguration configWithMapping;
    public Boolean isAccountWithValidMasterPlan;
    public WDDXData planData { get; set; }
    global AriaIsAccountEligibleForUpdate() {
        // setup AriaConfiguration
        isAccountWithValidMasterPlan=false;
        configWithMapping = AriaUtil.getLatestConfigWithMappings();
    }
    
    global boolean hasValidMasterPlanWithAriaId(String ariaId) {
        
        getAcctPlansAllEligibleForUpdateWithAriaId(ariaId);
        return isAccountWithValidMasterPlan;
        
    }
    
    global boolean hasValidMasterPlan(Id acctId) {
        
        getAcctPlansAllEligibleForUpdate(acctId);
        return isAccountWithValidMasterPlan;
        
    }
    
    global void getAcctPlansAllEligibleForUpdateWithAriaId (String ariaId) {
         System.debug(LoggingLevel.WARN, '********** Called AriaIsAccountEligibleForUpdate.getAcctPlansAllEligibleForUpdateWithAriaId');
         
         if (ariaId == null)  throw new AriaAPIException('No Id passed to this method.');
         
         //bail if config not found        
        if(configWithMapping == null) {
            throw new AriaAPIException('Could not find a valid Aria API configuration.');
        }
        
        Aria_API_Configuration__c config = configWithMapping.config;
        
          // build params Map for WS call
        Map<String, String> params = new Map<String, String>();
         // add Aria account ID
        AriaUtil.putParam(params, 'acct_no', ariaId, false);
        
        try {           
            // callout
            WDDXData result;
            if(!Test.isRunningTest()){
                result = AriaWebServicesGeneral.makeCall(  config.Aria_Remote_Site_URL__c, 
                                                                'get_acct_plans_all_m',
                                                                config.Client_No__c,
                                                                config.Auth_Key__c,
                                                                params
                                                                );
            }
            else{
                result = AriaWebServicesGeneral.getTestPacket('<wddxPacket version=\'1.0\'><header/><data><struct><var name=\'error_code\'><number>11</number></var><var name=\'error_msg\'><string>OK</string></var><var name=\'all_acct_plans_m\'><array length=\'4\'><struct><var name=\'plan_no\'><number>10343140</number></var><var name=\'plan_name\'><string>Test_Master_Plan_15</string></var><var name=\'plan_desc\'><string>Test_Master_Plan_15</string></var><var name=\'plan_instance_no\'><number>39209</number></var><var name=\'client_plan_instance_id\'><string>8182769964</string></var><var name=\'plan_date\'><string>2015-05-22</string></var><var name=\'plan_units\'><number>1</number></var><var name=\'last_bill_date\'><string>2015-05-22</string></var><var name=\'next_bill_date\'><string>2015-08-22</string></var><var name=\'bill_thru_date\'><string>2015-08-21</string></var><var name=\'bill_day\'><number>22</number></var><var name=\'recurring_billing_interval\'><number>3</number></var><var name=\'usage_billing_interval\'><number>3</number></var><var name=\'billing_ind\'><number>1</number></var><var name=\'display_ind\'><number>1</number></var><var name=\'rollover_months\'><null/></var><var name=\'rollover_plan_no\'><null/></var><var name=\'early_cancel_fee\'><null/></var><var name=\'early_cancel_min_months\'><number>2</number></var><var name=\'suspension_period\'><null/></var><var name=\'initial_plan_status\'><number>1</number></var><var name=\'rollover_plan_status\'><number>1</number></var><var name=\'rollover_plan_status_duration\'><null/></var><var name=\'rollover_plan_status_uom_cd\'><number>1</number></var><var name=\'init_free_period_duration\'><number>1</number></var><var name=\'init_free_period_uom_cd\'><null/></var><var name=\'plan_2_assign_on_susp\'><null/></var><var name=\'default_notify_method\'><null/></var><var name=\'prepaid_ind\'><number>0</number></var><var name=\'currency_cd\'><string>usd</string></var><var name=\'rate_schedule_no\'><number>11248840</number></var><var name=\'rate_schedule_name\'><string>Rate-Schedule-Name USD1</string></var><var name=\'rate_sched_is_default_ind\'><number>1</number></var><var name=\'supp_plan_ind\'><number>0</number></var><var name=\'plan_instance_status_cd\'><number>1</number></var><var name=\'plan_instance_status_label\'><string>Active</string></var><var name=\'plan_instance_status_date\'><string>2015-05-22</string></var><var name=\'dunning_state\'><number>0</number></var><var name=\'dunning_step\'><null/></var><var name=\'dunning_degrade_date\'><null/></var><var name=\'plan_assignment_date\'><string>2015-05-22</string></var><var name=\'plan_deprovisioned_date\'><null/></var><var name=\'client_receipt_id\'><null/></var><var name=\'client_plan_id\'><string>Test_Master_Plan_15</string></var><var name=\'client_rollover_plan_id\'><null/></var><var name=\'client_plan_2_assign_on_susp\'><null/></var><var name=\'client_rate_schedule_id\'><string>Rate-Schedule-Name_USD1</string></var><var name=\'proration_invoice_timing_cd\'><string>I</string></var><var name=\'master_plan_instance_no\'><number>39209</number></var><var name=\'client_master_plan_instance_id\'><string>8182769964</string></var><var name=\'parent_plan_instance_no\'><null/></var><var name=\'client_parent_plan_instance_id\'><null/></var><var name=\'plan_services\'><array length=\'6\'><struct><var name=\'service_no\'><number>100</number></var><var name=\'service_desc\'><string>Minimum Fee</string></var><var name=\'is_recurring_ind\'><number>1</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>1</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>1</number></var><var name=\'is_donation_ind\'><number>0</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1000</string></var><var name=\'ledger_code\'><string>1000</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>1</number></var><var name=\'client_service_id\'><string>100</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Recurring Flat Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>6000</number></var><var name=\'monthly_fee\'><number>2000</number></var><var name=\'client_rate_schedule_id\'><string>Rate-Schedule-Name_USD1</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct><struct><var name=\'service_no\'><number>101</number></var><var name=\'service_desc\'><string>Activation Fee</string></var><var name=\'is_recurring_ind\'><number>0</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>1</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>0</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1001</string></var><var name=\'ledger_code\'><string>1001</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>101</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Setup Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>1000</number></var><var name=\'monthly_fee\'><null/></var><var name=\'client_rate_schedule_id\'><string>Rate-Schedule-Name_USD1</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct><struct><var name=\'service_no\'><number>198</number></var><var name=\'service_desc\'><string>Late Fee</string></var><var name=\'is_recurring_ind\'><number>0</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>1</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>1</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>1</number></var><var name=\'is_donation_ind\'><number>0</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>3001</string></var><var name=\'ledger_code\'><string>3001</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>198</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Item Orders</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>3000</number></var><var name=\'monthly_fee\'><null/></var><var name=\'client_rate_schedule_id\'><string>Rate-Schedule-Name_USD1</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct><struct><var name=\'service_no\'><number>10003120</number></var><var name=\'service_desc\'><string>Minimum Fee</string></var><var name=\'is_recurring_ind\'><number>1</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>1</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>1</number></var><var name=\'is_donation_ind\'><number>0</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1002</string></var><var name=\'ledger_code\'><string>1002</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>10003120</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Recurring Flat Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'2\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><number>10</number></var><var name=\'rate_per_unit\'><number>4000</number></var><var name=\'monthly_fee\'><number>1333.33</number></var><var name=\'client_rate_schedule_id\'><string>Rate-Schedule-Name_USD1</string></var><var name=\'rate_tier_description\'><null/></var></struct><struct><var name=\'rate_seq_no\'><number>2</number></var><var name=\'from_unit\'><number>11</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>5000</number></var><var name=\'monthly_fee\'><number>1666.67</number></var><var name=\'client_rate_schedule_id\'><string>Rate-Schedule-Name_USD1</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct><struct><var name=\'service_no\'><number>10003126</number></var><var name=\'service_desc\'><string>Donation</string></var><var name=\'is_recurring_ind\'><number>1</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>1</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1002</string></var><var name=\'ledger_code\'><string>1002</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>10003126</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Recurring Flat Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><null/></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>343</number></var><var name=\'monthly_fee\'><number>114.33</number></var><var name=\'client_rate_schedule_id\'><string>Rate-Schedule-Name_USD1</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct><struct><var name=\'service_no\'><number>10136229</number></var><var name=\'service_desc\'><string>Cancellation Fee</string></var><var name=\'is_recurring_ind\'><number>0</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>0</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>1</number></var><var name=\'coa_id\'><string>10085069</string></var><var name=\'ledger_code\'><string>10085069</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>10003128</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>GL123456</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>2000</number></var><var name=\'monthly_fee\'><null/></var><var name=\'client_rate_schedule_id\'><string>Rate-Schedule-Name_USD1</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct></array></var><var name=\'surcharges_all\'><null/></var><var name=\'product_fields\'><array length=\'4\'><struct><var name=\'field_name\'><string>PF1</string></var><var name=\'field_value\'><string>PF1</string></var></struct><struct><var name=\'field_name\'><string>PF2</string></var><var name=\'field_value\'><string>PF2</string></var></struct><struct><var name=\'field_name\'><string>SFDC_PlanName</string></var><var name=\'field_value\'><string>SFDC_PlanName</string></var></struct><struct><var name=\'field_name\'><string>PF_SAN</string></var><var name=\'field_value\'><string>PF_SAN</string></var></struct></array></var><var name=\'plan_instance_fields_detail\'><array length=\'4\'><struct><var name=\'field_name\'><string>PFI1</string></var><var name=\'field_value\'><string>Sub PF 1</string></var></struct><struct><var name=\'field_name\'><string>PFI2</string></var><var name=\'field_value\'><string>Sub PF 2</string></var></struct><struct><var name=\'field_name\'><string>PFI3</string></var><var name=\'field_value\'><string>Sub PF 3</string></var></struct><struct><var name=\'field_name\'><string>PF_SAN_i</string></var><var name=\'field_value\'><string>Sub PF_SAN_i</string></var></struct></array></var></struct><struct><var name=\'plan_no\'><number>10343137</number></var><var name=\'plan_name\'><string>Test_Master_Plan_14</string></var><var name=\'plan_desc\'><string>Test_Master_Plan_14</string></var><var name=\'plan_instance_no\'><number>39206</number></var><var name=\'client_plan_instance_id\'><string>6619897482</string></var><var name=\'plan_date\'><string>2015-05-22</string></var><var name=\'plan_units\'><number>1</number></var><var name=\'last_bill_date\'><string>2015-05-22</string></var><var name=\'next_bill_date\'><string>2015-06-22</string></var><var name=\'bill_thru_date\'><string>2015-06-21</string></var><var name=\'bill_day\'><number>22</number></var><var name=\'recurring_billing_interval\'><number>1</number></var><var name=\'usage_billing_interval\'><number>1</number></var><var name=\'billing_ind\'><number>1</number></var><var name=\'display_ind\'><number>1</number></var><var name=\'rollover_months\'><null/></var><var name=\'rollover_plan_no\'><null/></var><var name=\'early_cancel_fee\'><null/></var><var name=\'early_cancel_min_months\'><number>2</number></var><var name=\'suspension_period\'><null/></var><var name=\'initial_plan_status\'><number>1</number></var><var name=\'rollover_plan_status\'><number>1</number></var><var name=\'rollover_plan_status_duration\'><null/></var><var name=\'rollover_plan_status_uom_cd\'><number>1</number></var><var name=\'init_free_period_duration\'><number>1</number></var><var name=\'init_free_period_uom_cd\'><null/></var><var name=\'plan_2_assign_on_susp\'><null/></var><var name=\'default_notify_method\'><null/></var><var name=\'prepaid_ind\'><number>0</number></var><var name=\'currency_cd\'><string>usd</string></var><var name=\'rate_schedule_no\'><number>11248831</number></var><var name=\'rate_schedule_name\'><string>DefaultRateScheduleName-USD1</string></var><var name=\'rate_sched_is_default_ind\'><number>1</number></var><var name=\'supp_plan_ind\'><number>0</number></var><var name=\'plan_instance_status_cd\'><number>1</number></var><var name=\'plan_instance_status_label\'><string>Active</string></var><var name=\'plan_instance_status_date\'><string>2015-05-22</string></var><var name=\'dunning_state\'><number>0</number></var><var name=\'dunning_step\'><null/></var><var name=\'dunning_degrade_date\'><null/></var><var name=\'plan_assignment_date\'><string>2015-05-22</string></var><var name=\'plan_deprovisioned_date\'><null/></var><var name=\'client_receipt_id\'><null/></var><var name=\'client_plan_id\'><string>_Test_Master_Plan_14</string></var><var name=\'client_rollover_plan_id\'><null/></var><var name=\'client_plan_2_assign_on_susp\'><null/></var><var name=\'client_rate_schedule_id\'><string>DefaultRateScheduleName-USD</string></var><var name=\'proration_invoice_timing_cd\'><string>I</string></var><var name=\'master_plan_instance_no\'><number>39206</number></var><var name=\'client_master_plan_instance_id\'><string>6619897482</string></var><var name=\'parent_plan_instance_no\'><null/></var><var name=\'client_parent_plan_instance_id\'><null/></var><var name=\'plan_services\'><array length=\'2\'><struct><var name=\'service_no\'><number>10003126</number></var><var name=\'service_desc\'><string>Donation</string></var><var name=\'is_recurring_ind\'><number>1</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>1</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1002</string></var><var name=\'ledger_code\'><string>1002</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>10003126</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Recurring Flat Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><null/></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>4343</number></var><var name=\'monthly_fee\'><number>4343</number></var><var name=\'client_rate_schedule_id\'><string>DefaultRateScheduleName-USD</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct><struct><var name=\'service_no\'><number>10136229</number></var><var name=\'service_desc\'><string>Cancellation Fee</string></var><var name=\'is_recurring_ind\'><number>0</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>0</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>1</number></var><var name=\'coa_id\'><string>10085069</string></var><var name=\'ledger_code\'><string>10085069</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>10003128</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>GL123456</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>100</number></var><var name=\'monthly_fee\'><null/></var><var name=\'client_rate_schedule_id\'><string>DefaultRateScheduleName-USD</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct></array></var><var name=\'surcharges_all\'><null/></var><var name=\'product_fields\'><array length=\'4\'><struct><var name=\'field_name\'><string>PF1</string></var><var name=\'field_value\'><string>PF1</string></var></struct><struct><var name=\'field_name\'><string>PF2</string></var><var name=\'field_value\'><string>PF2</string></var></struct><struct><var name=\'field_name\'><string>SFDC_PlanName</string></var><var name=\'field_value\'><string>SFDC_PlanName</string></var></struct><struct><var name=\'field_name\'><string>PF_SAN</string></var><var name=\'field_value\'><string>PF_SAN</string></var></struct></array></var><var name=\'plan_instance_fields_detail\'><array length=\'4\'><struct><var name=\'field_name\'><string>PFI1</string></var><var name=\'field_value\'><string>Sub PF 1</string></var></struct><struct><var name=\'field_name\'><string>PFI2</string></var><var name=\'field_value\'><string>Sub PF 2</string></var></struct><struct><var name=\'field_name\'><string>PFI3</string></var><var name=\'field_value\'><string>Sub PF 3</string></var></struct><struct><var name=\'field_name\'><string>PF_SAN_i</string></var><var name=\'field_value\'><string>Sub PF_SAN_i</string></var></struct></array></var></struct><struct><var name=\'plan_no\'><number>10343173</number></var><var name=\'plan_name\'><string>Sub_Plan_E</string></var><var name=\'plan_desc\'><string>Sub_Plan_E</string></var><var name=\'plan_instance_no\'><number>39208</number></var><var name=\'client_plan_instance_id\'><string>8748094877</string></var><var name=\'plan_date\'><string>2015-05-22</string></var><var name=\'plan_units\'><number>1</number></var><var name=\'last_bill_date\'><string>2015-05-22</string></var><var name=\'next_bill_date\'><string>2015-06-22</string></var><var name=\'bill_thru_date\'><string>2015-06-21</string></var><var name=\'bill_day\'><number>22</number></var><var name=\'recurring_billing_interval\'><number>1</number></var><var name=\'usage_billing_interval\'><number>1</number></var><var name=\'billing_ind\'><number>1</number></var><var name=\'display_ind\'><number>1</number></var><var name=\'rollover_months\'><null/></var><var name=\'rollover_plan_no\'><null/></var><var name=\'early_cancel_fee\'><null/></var><var name=\'early_cancel_min_months\'><null/></var><var name=\'suspension_period\'><null/></var><var name=\'initial_plan_status\'><null/></var><var name=\'rollover_plan_status\'><null/></var><var name=\'rollover_plan_status_duration\'><null/></var><var name=\'rollover_plan_status_uom_cd\'><null/></var><var name=\'init_free_period_duration\'><null/></var><var name=\'init_free_period_uom_cd\'><number>1</number></var><var name=\'plan_2_assign_on_susp\'><null/></var><var name=\'default_notify_method\'><null/></var><var name=\'prepaid_ind\'><number>0</number></var><var name=\'currency_cd\'><string>usd</string></var><var name=\'rate_schedule_no\'><number>11248897</number></var><var name=\'rate_schedule_name\'><string>Default-RSN USD</string></var><var name=\'rate_sched_is_default_ind\'><number>1</number></var><var name=\'supp_plan_ind\'><number>1</number></var><var name=\'plan_instance_status_cd\'><number>1</number></var><var name=\'plan_instance_status_label\'><string>Active</string></var><var name=\'plan_instance_status_date\'><string>2015-05-22</string></var><var name=\'dunning_state\'><null/></var><var name=\'dunning_step\'><null/></var><var name=\'dunning_degrade_date\'><null/></var><var name=\'plan_assignment_date\'><string>2015-05-22</string></var><var name=\'plan_deprovisioned_date\'><null/></var><var name=\'client_receipt_id\'><null/></var><var name=\'client_plan_id\'><string>Sub_Plan_E</string></var><var name=\'client_rollover_plan_id\'><null/></var><var name=\'client_plan_2_assign_on_susp\'><null/></var><var name=\'client_rate_schedule_id\'><string>Default-RSN_USD</string></var><var name=\'proration_invoice_timing_cd\'><string>I</string></var><var name=\'master_plan_instance_no\'><number>39206</number></var><var name=\'client_master_plan_instance_id\'><string>6619897482</string></var><var name=\'parent_plan_instance_no\'><number>39206</number></var><var name=\'client_parent_plan_instance_id\'><string>6619897482</string></var><var name=\'plan_services\'><array length=\'2\'><struct><var name=\'service_no\'><number>101</number></var><var name=\'service_desc\'><string>Activation Fee</string></var><var name=\'is_recurring_ind\'><number>0</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>1</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>0</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1001</string></var><var name=\'ledger_code\'><string>1001</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>101</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Setup Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>4000</number></var><var name=\'monthly_fee\'><null/></var><var name=\'client_rate_schedule_id\'><string>Default-RSN_USD</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct><struct><var name=\'service_no\'><number>10003126</number></var><var name=\'service_desc\'><string>Donation</string></var><var name=\'is_recurring_ind\'><number>1</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>1</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1002</string></var><var name=\'ledger_code\'><string>1002</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>10003126</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Recurring Flat Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>211</number></var><var name=\'monthly_fee\'><number>211</number></var><var name=\'client_rate_schedule_id\'><string>Default-RSN_USD</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct></array></var><var name=\'surcharges_all\'><null/></var><var name=\'product_fields\'><array length=\'4\'><struct><var name=\'field_name\'><string>PF1</string></var><var name=\'field_value\'><string>SubPF1</string></var></struct><struct><var name=\'field_name\'><string>PF2</string></var><var name=\'field_value\'><string>SubPF2</string></var></struct><struct><var name=\'field_name\'><string>SFDC_PlanName</string></var><var name=\'field_value\'><string>SubSFDC_PlanName</string></var></struct><struct><var name=\'field_name\'><string>PF_SAN</string></var><var name=\'field_value\'><string>SubPF_SAN</string></var></struct></array></var><var name=\'plan_instance_fields_detail\'><array length=\'4\'><struct><var name=\'field_name\'><string>PFI1</string></var><var name=\'field_value\'><string>Sub-PF 1</string></var></struct><struct><var name=\'field_name\'><string>PFI2</string></var><var name=\'field_value\'><string>Sub-PF 2</string></var></struct><struct><var name=\'field_name\'><string>PFI3</string></var><var name=\'field_value\'><string>Sub-PF 3</string></var></struct><struct><var name=\'field_name\'><string>PF_SAN_i</string></var><var name=\'field_value\'><string>SubPF_SAN_i</string></var></struct></array></var></struct><struct><var name=\'plan_no\'><number>10343176</number></var><var name=\'plan_name\'><string>Sub_Plan_G</string></var><var name=\'plan_desc\'><string>Sub_Plan_G</string></var><var name=\'plan_instance_no\'><number>39207</number></var><var name=\'client_plan_instance_id\'><string>8556193849</string></var><var name=\'plan_date\'><string>2015-05-22</string></var><var name=\'plan_units\'><number>1</number></var><var name=\'last_bill_date\'><string>2015-05-22</string></var><var name=\'next_bill_date\'><string>2015-06-22</string></var><var name=\'bill_thru_date\'><string>2015-06-21</string></var><var name=\'bill_day\'><number>22</number></var><var name=\'recurring_billing_interval\'><number>1</number></var><var name=\'usage_billing_interval\'><number>1</number></var><var name=\'billing_ind\'><number>1</number></var><var name=\'display_ind\'><number>1</number></var><var name=\'rollover_months\'><null/></var><var name=\'rollover_plan_no\'><null/></var><var name=\'early_cancel_fee\'><null/></var><var name=\'early_cancel_min_months\'><null/></var><var name=\'suspension_period\'><null/></var><var name=\'initial_plan_status\'><null/></var><var name=\'rollover_plan_status\'><null/></var><var name=\'rollover_plan_status_duration\'><null/></var><var name=\'rollover_plan_status_uom_cd\'><null/></var><var name=\'init_free_period_duration\'><null/></var><var name=\'init_free_period_uom_cd\'><number>1</number></var><var name=\'plan_2_assign_on_susp\'><null/></var><var name=\'default_notify_method\'><null/></var><var name=\'prepaid_ind\'><number>0</number></var><var name=\'currency_cd\'><string>usd</string></var><var name=\'rate_schedule_no\'><number>11248900</number></var><var name=\'rate_schedule_name\'><string>Default RSN--USD</string></var><var name=\'rate_sched_is_default_ind\'><number>1</number></var><var name=\'supp_plan_ind\'><number>1</number></var><var name=\'plan_instance_status_cd\'><number>1</number></var><var name=\'plan_instance_status_label\'><string>Active</string></var><var name=\'plan_instance_status_date\'><string>2015-05-22</string></var><var name=\'dunning_state\'><null/></var><var name=\'dunning_step\'><null/></var><var name=\'dunning_degrade_date\'><null/></var><var name=\'plan_assignment_date\'><string>2015-05-22</string></var><var name=\'plan_deprovisioned_date\'><null/></var><var name=\'client_receipt_id\'><null/></var><var name=\'client_plan_id\'><string>Sub_Plan_G</string></var><var name=\'client_rollover_plan_id\'><null/></var><var name=\'client_plan_2_assign_on_susp\'><null/></var><var name=\'client_rate_schedule_id\'><string>Default_RSN--USD</string></var><var name=\'proration_invoice_timing_cd\'><string>I</string></var><var name=\'master_plan_instance_no\'><number>39206</number></var><var name=\'client_master_plan_instance_id\'><string>6619897482</string></var><var name=\'parent_plan_instance_no\'><number>39206</number></var><var name=\'client_parent_plan_instance_id\'><string>6619897482</string></var><var name=\'plan_services\'><array length=\'2\'><struct><var name=\'service_no\'><number>0</number></var><var name=\'service_desc\'><string>Account Credit</string></var><var name=\'is_recurring_ind\'><number>0</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>0</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1000</string></var><var name=\'ledger_code\'><string>1000</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>0</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Recurring Flat Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>10000</number></var><var name=\'monthly_fee\'><null/></var><var name=\'client_rate_schedule_id\'><string>Default_RSN--USD</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct><struct><var name=\'service_no\'><number>10003126</number></var><var name=\'service_desc\'><string>Donation</string></var><var name=\'is_recurring_ind\'><number>1</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>1</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1002</string></var><var name=\'ledger_code\'><string>1002</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>10003126</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Recurring Flat Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>7778</number></var><var name=\'monthly_fee\'><number>7778</number></var><var name=\'client_rate_schedule_id\'><string>Default_RSN--USD</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct></array></var><var name=\'surcharges_all\'><null/></var><var name=\'product_fields\'><array length=\'4\'><struct><var name=\'field_name\'><string>PF1</string></var><var name=\'field_value\'><string>Sub PF1</string></var></struct><struct><var name=\'field_name\'><string>PF2</string></var><var name=\'field_value\'><string>Sub PF2</string></var></struct><struct><var name=\'field_name\'><string>SFDC_PlanName</string></var><var name=\'field_value\'><string>SubSFDC_PlanName</string></var></struct><struct><var name=\'field_name\'><string>PF_SAN</string></var><var name=\'field_value\'><string>SubPF_SAN</string></var></struct></array></var><var name=\'plan_instance_fields_detail\'><array length=\'4\'><struct><var name=\'field_name\'><string>PFI1</string></var><var name=\'field_value\'><string>Sub PF 1</string></var></struct><struct><var name=\'field_name\'><string>PFI2</string></var><var name=\'field_value\'><string>Sub PF 2</string></var></struct><struct><var name=\'field_name\'><string>PFI3</string></var><var name=\'field_value\'><string>Sub PF 3</string></var></struct><struct><var name=\'field_name\'><string>PF_SAN_i</string></var><var name=\'field_value\'><string>Sub PF_SAN_i</string></var></struct></array></var></struct></array></var></struct></data></wddxPacket>');
            }
            
            planData = result;
              
       
            System.debug(LoggingLevel.WARN, '********** Made callout to get_acct_plans_all from getAcctPlansAllEligibleForUpdate');
        
            
            // this method modifies a by reference
            Account a;
            handleResult(a, result); // throws AriaAPIException
            
        } catch (AriaAPIException e) {

            AriaUtil.logAriaError( 'Get Account Plans All EligibleForUpdateWithAriaId Error\nAria account number: ' + ariaId + '\n' +e.getMessage()+'\nOn line number: '+e.getLineNumber(), e.getTypeName() );
            
        } catch (Exception e) {
            // do something?
            AriaUtil.logAriaError( 'Get Account Plans All EligibleForUpdateWithAriaId Error\nAria account number: ' + ariaId + '\n' +e.getMessage()+'\nOn line number: '+e.getLineNumber(), e.getTypeName() );
            System.debug(LoggingLevel.WARN, 'OOPS');
        }
        
        // call finish, which will upsert the results
        System.debug(LoggingLevel.WARN, '********** Calling finish method');
        finish();
    }
    
    
    global void getAcctPlansAllEligibleForUpdate(Id accId) {
        System.debug(LoggingLevel.WARN, '********** Called AriaIsAccountEligibleForUpdate.getAcctPlansAllEligibleForUpdate');

        if (accId == null)  throw new AriaAPIException('No Id passed to this method.');
        
        
        //bail if config not found        
        if(configWithMapping == null) {
            throw new AriaAPIException('Could not find a valid Aria API configuration.');
        }
        
        Aria_API_Configuration__c config = configWithMapping.config;
        
        List<Account> accs = [SELECT a.Id, a.Aria_Id__c FROM Account a WHERE a.Id = :accId LIMIT 1];
        
        if (accs.IsEmpty()) throw new AriaAPIException('No Account returned by query.');
        
        // extract the one Account from query result
        Account a = accs[0];
        
        // check for Aria Id
        if (a.Aria_Id__c == null) throw new AriaAPIException('No Aria ID on Account');
        
        // issue call and perform processing
        
        // build params Map for WS call
        Map<String, String> params = new Map<String, String>();
        
        // add Aria account ID
        AriaUtil.putParam(params, 'acct_no', a.Aria_Id__c, false);
        
        try {           
            // callout
            WDDXData result;
            
            if(!Test.isRunningTest()){
                result = AriaWebServicesGeneral.makeCall(  config.Aria_Remote_Site_URL__c, 
                                                                'get_acct_plans_all_m',
                                                                config.Client_No__c,
                                                                config.Auth_Key__c,
                                                                params
                                                                );
            }
            else
            {
                result = AriaWebServicesGeneral.getTestPacket('<wddxPacket version=\'1.0\'><header/><data><struct><var name=\'error_code\'><number>11</number></var><var name=\'error_msg\'><string>OK</string></var><var name=\'all_acct_plans_m\'><array length=\'4\'><struct><var name=\'plan_no\'><number>10343140</number></var><var name=\'plan_name\'><string>Test_Master_Plan_15</string></var><var name=\'plan_desc\'><string>Test_Master_Plan_15</string></var><var name=\'plan_instance_no\'><number>39209</number></var><var name=\'client_plan_instance_id\'><string>8182769964</string></var><var name=\'plan_date\'><string>2015-05-22</string></var><var name=\'plan_units\'><number>1</number></var><var name=\'last_bill_date\'><string>2015-05-22</string></var><var name=\'next_bill_date\'><string>2015-08-22</string></var><var name=\'bill_thru_date\'><string>2015-08-21</string></var><var name=\'bill_day\'><number>22</number></var><var name=\'recurring_billing_interval\'><number>3</number></var><var name=\'usage_billing_interval\'><number>3</number></var><var name=\'billing_ind\'><number>1</number></var><var name=\'display_ind\'><number>1</number></var><var name=\'rollover_months\'><null/></var><var name=\'rollover_plan_no\'><null/></var><var name=\'early_cancel_fee\'><null/></var><var name=\'early_cancel_min_months\'><number>2</number></var><var name=\'suspension_period\'><null/></var><var name=\'initial_plan_status\'><number>1</number></var><var name=\'rollover_plan_status\'><number>1</number></var><var name=\'rollover_plan_status_duration\'><null/></var><var name=\'rollover_plan_status_uom_cd\'><number>1</number></var><var name=\'init_free_period_duration\'><number>1</number></var><var name=\'init_free_period_uom_cd\'><null/></var><var name=\'plan_2_assign_on_susp\'><null/></var><var name=\'default_notify_method\'><null/></var><var name=\'prepaid_ind\'><number>0</number></var><var name=\'currency_cd\'><string>usd</string></var><var name=\'rate_schedule_no\'><number>11248840</number></var><var name=\'rate_schedule_name\'><string>Rate-Schedule-Name USD1</string></var><var name=\'rate_sched_is_default_ind\'><number>1</number></var><var name=\'supp_plan_ind\'><number>0</number></var><var name=\'plan_instance_status_cd\'><number>1</number></var><var name=\'plan_instance_status_label\'><string>Active</string></var><var name=\'plan_instance_status_date\'><string>2015-05-22</string></var><var name=\'dunning_state\'><number>0</number></var><var name=\'dunning_step\'><null/></var><var name=\'dunning_degrade_date\'><null/></var><var name=\'plan_assignment_date\'><string>2015-05-22</string></var><var name=\'plan_deprovisioned_date\'><null/></var><var name=\'client_receipt_id\'><null/></var><var name=\'client_plan_id\'><string>Test_Master_Plan_15</string></var><var name=\'client_rollover_plan_id\'><null/></var><var name=\'client_plan_2_assign_on_susp\'><null/></var><var name=\'client_rate_schedule_id\'><string>Rate-Schedule-Name_USD1</string></var><var name=\'proration_invoice_timing_cd\'><string>I</string></var><var name=\'master_plan_instance_no\'><number>39209</number></var><var name=\'client_master_plan_instance_id\'><string>8182769964</string></var><var name=\'parent_plan_instance_no\'><null/></var><var name=\'client_parent_plan_instance_id\'><null/></var><var name=\'plan_services\'><array length=\'6\'><struct><var name=\'service_no\'><number>100</number></var><var name=\'service_desc\'><string>Minimum Fee</string></var><var name=\'is_recurring_ind\'><number>1</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>1</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>1</number></var><var name=\'is_donation_ind\'><number>0</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1000</string></var><var name=\'ledger_code\'><string>1000</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>1</number></var><var name=\'client_service_id\'><string>100</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Recurring Flat Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>6000</number></var><var name=\'monthly_fee\'><number>2000</number></var><var name=\'client_rate_schedule_id\'><string>Rate-Schedule-Name_USD1</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct><struct><var name=\'service_no\'><number>101</number></var><var name=\'service_desc\'><string>Activation Fee</string></var><var name=\'is_recurring_ind\'><number>0</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>1</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>0</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1001</string></var><var name=\'ledger_code\'><string>1001</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>101</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Setup Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>1000</number></var><var name=\'monthly_fee\'><null/></var><var name=\'client_rate_schedule_id\'><string>Rate-Schedule-Name_USD1</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct><struct><var name=\'service_no\'><number>198</number></var><var name=\'service_desc\'><string>Late Fee</string></var><var name=\'is_recurring_ind\'><number>0</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>1</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>1</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>1</number></var><var name=\'is_donation_ind\'><number>0</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>3001</string></var><var name=\'ledger_code\'><string>3001</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>198</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Item Orders</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>3000</number></var><var name=\'monthly_fee\'><null/></var><var name=\'client_rate_schedule_id\'><string>Rate-Schedule-Name_USD1</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct><struct><var name=\'service_no\'><number>10003120</number></var><var name=\'service_desc\'><string>Minimum Fee</string></var><var name=\'is_recurring_ind\'><number>1</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>1</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>1</number></var><var name=\'is_donation_ind\'><number>0</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1002</string></var><var name=\'ledger_code\'><string>1002</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>10003120</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Recurring Flat Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'2\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><number>10</number></var><var name=\'rate_per_unit\'><number>4000</number></var><var name=\'monthly_fee\'><number>1333.33</number></var><var name=\'client_rate_schedule_id\'><string>Rate-Schedule-Name_USD1</string></var><var name=\'rate_tier_description\'><null/></var></struct><struct><var name=\'rate_seq_no\'><number>2</number></var><var name=\'from_unit\'><number>11</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>5000</number></var><var name=\'monthly_fee\'><number>1666.67</number></var><var name=\'client_rate_schedule_id\'><string>Rate-Schedule-Name_USD1</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct><struct><var name=\'service_no\'><number>10003126</number></var><var name=\'service_desc\'><string>Donation</string></var><var name=\'is_recurring_ind\'><number>1</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>1</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1002</string></var><var name=\'ledger_code\'><string>1002</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>10003126</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Recurring Flat Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><null/></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>343</number></var><var name=\'monthly_fee\'><number>114.33</number></var><var name=\'client_rate_schedule_id\'><string>Rate-Schedule-Name_USD1</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct><struct><var name=\'service_no\'><number>10136229</number></var><var name=\'service_desc\'><string>Cancellation Fee</string></var><var name=\'is_recurring_ind\'><number>0</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>0</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>1</number></var><var name=\'coa_id\'><string>10085069</string></var><var name=\'ledger_code\'><string>10085069</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>10003128</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>GL123456</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>2000</number></var><var name=\'monthly_fee\'><null/></var><var name=\'client_rate_schedule_id\'><string>Rate-Schedule-Name_USD1</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct></array></var><var name=\'surcharges_all\'><null/></var><var name=\'product_fields\'><array length=\'4\'><struct><var name=\'field_name\'><string>PF1</string></var><var name=\'field_value\'><string>PF1</string></var></struct><struct><var name=\'field_name\'><string>PF2</string></var><var name=\'field_value\'><string>PF2</string></var></struct><struct><var name=\'field_name\'><string>SFDC_PlanName</string></var><var name=\'field_value\'><string>SFDC_PlanName</string></var></struct><struct><var name=\'field_name\'><string>PF_SAN</string></var><var name=\'field_value\'><string>PF_SAN</string></var></struct></array></var><var name=\'plan_instance_fields_detail\'><array length=\'4\'><struct><var name=\'field_name\'><string>PFI1</string></var><var name=\'field_value\'><string>Sub PF 1</string></var></struct><struct><var name=\'field_name\'><string>PFI2</string></var><var name=\'field_value\'><string>Sub PF 2</string></var></struct><struct><var name=\'field_name\'><string>PFI3</string></var><var name=\'field_value\'><string>Sub PF 3</string></var></struct><struct><var name=\'field_name\'><string>PF_SAN_i</string></var><var name=\'field_value\'><string>Sub PF_SAN_i</string></var></struct></array></var></struct><struct><var name=\'plan_no\'><number>10343137</number></var><var name=\'plan_name\'><string>Test_Master_Plan_14</string></var><var name=\'plan_desc\'><string>Test_Master_Plan_14</string></var><var name=\'plan_instance_no\'><number>39206</number></var><var name=\'client_plan_instance_id\'><string>6619897482</string></var><var name=\'plan_date\'><string>2015-05-22</string></var><var name=\'plan_units\'><number>1</number></var><var name=\'last_bill_date\'><string>2015-05-22</string></var><var name=\'next_bill_date\'><string>2015-06-22</string></var><var name=\'bill_thru_date\'><string>2015-06-21</string></var><var name=\'bill_day\'><number>22</number></var><var name=\'recurring_billing_interval\'><number>1</number></var><var name=\'usage_billing_interval\'><number>1</number></var><var name=\'billing_ind\'><number>1</number></var><var name=\'display_ind\'><number>1</number></var><var name=\'rollover_months\'><null/></var><var name=\'rollover_plan_no\'><null/></var><var name=\'early_cancel_fee\'><null/></var><var name=\'early_cancel_min_months\'><number>2</number></var><var name=\'suspension_period\'><null/></var><var name=\'initial_plan_status\'><number>1</number></var><var name=\'rollover_plan_status\'><number>1</number></var><var name=\'rollover_plan_status_duration\'><null/></var><var name=\'rollover_plan_status_uom_cd\'><number>1</number></var><var name=\'init_free_period_duration\'><number>1</number></var><var name=\'init_free_period_uom_cd\'><null/></var><var name=\'plan_2_assign_on_susp\'><null/></var><var name=\'default_notify_method\'><null/></var><var name=\'prepaid_ind\'><number>0</number></var><var name=\'currency_cd\'><string>usd</string></var><var name=\'rate_schedule_no\'><number>11248831</number></var><var name=\'rate_schedule_name\'><string>DefaultRateScheduleName-USD1</string></var><var name=\'rate_sched_is_default_ind\'><number>1</number></var><var name=\'supp_plan_ind\'><number>0</number></var><var name=\'plan_instance_status_cd\'><number>1</number></var><var name=\'plan_instance_status_label\'><string>Active</string></var><var name=\'plan_instance_status_date\'><string>2015-05-22</string></var><var name=\'dunning_state\'><number>0</number></var><var name=\'dunning_step\'><null/></var><var name=\'dunning_degrade_date\'><null/></var><var name=\'plan_assignment_date\'><string>2015-05-22</string></var><var name=\'plan_deprovisioned_date\'><null/></var><var name=\'client_receipt_id\'><null/></var><var name=\'client_plan_id\'><string>_Test_Master_Plan_14</string></var><var name=\'client_rollover_plan_id\'><null/></var><var name=\'client_plan_2_assign_on_susp\'><null/></var><var name=\'client_rate_schedule_id\'><string>DefaultRateScheduleName-USD</string></var><var name=\'proration_invoice_timing_cd\'><string>I</string></var><var name=\'master_plan_instance_no\'><number>39206</number></var><var name=\'client_master_plan_instance_id\'><string>6619897482</string></var><var name=\'parent_plan_instance_no\'><null/></var><var name=\'client_parent_plan_instance_id\'><null/></var><var name=\'plan_services\'><array length=\'2\'><struct><var name=\'service_no\'><number>10003126</number></var><var name=\'service_desc\'><string>Donation</string></var><var name=\'is_recurring_ind\'><number>1</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>1</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1002</string></var><var name=\'ledger_code\'><string>1002</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>10003126</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Recurring Flat Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><null/></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>4343</number></var><var name=\'monthly_fee\'><number>4343</number></var><var name=\'client_rate_schedule_id\'><string>DefaultRateScheduleName-USD</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct><struct><var name=\'service_no\'><number>10136229</number></var><var name=\'service_desc\'><string>Cancellation Fee</string></var><var name=\'is_recurring_ind\'><number>0</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>0</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>1</number></var><var name=\'coa_id\'><string>10085069</string></var><var name=\'ledger_code\'><string>10085069</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>10003128</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>GL123456</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>100</number></var><var name=\'monthly_fee\'><null/></var><var name=\'client_rate_schedule_id\'><string>DefaultRateScheduleName-USD</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct></array></var><var name=\'surcharges_all\'><null/></var><var name=\'product_fields\'><array length=\'4\'><struct><var name=\'field_name\'><string>PF1</string></var><var name=\'field_value\'><string>PF1</string></var></struct><struct><var name=\'field_name\'><string>PF2</string></var><var name=\'field_value\'><string>PF2</string></var></struct><struct><var name=\'field_name\'><string>SFDC_PlanName</string></var><var name=\'field_value\'><string>SFDC_PlanName</string></var></struct><struct><var name=\'field_name\'><string>PF_SAN</string></var><var name=\'field_value\'><string>PF_SAN</string></var></struct></array></var><var name=\'plan_instance_fields_detail\'><array length=\'4\'><struct><var name=\'field_name\'><string>PFI1</string></var><var name=\'field_value\'><string>Sub PF 1</string></var></struct><struct><var name=\'field_name\'><string>PFI2</string></var><var name=\'field_value\'><string>Sub PF 2</string></var></struct><struct><var name=\'field_name\'><string>PFI3</string></var><var name=\'field_value\'><string>Sub PF 3</string></var></struct><struct><var name=\'field_name\'><string>PF_SAN_i</string></var><var name=\'field_value\'><string>Sub PF_SAN_i</string></var></struct></array></var></struct><struct><var name=\'plan_no\'><number>10343173</number></var><var name=\'plan_name\'><string>Sub_Plan_E</string></var><var name=\'plan_desc\'><string>Sub_Plan_E</string></var><var name=\'plan_instance_no\'><number>39208</number></var><var name=\'client_plan_instance_id\'><string>8748094877</string></var><var name=\'plan_date\'><string>2015-05-22</string></var><var name=\'plan_units\'><number>1</number></var><var name=\'last_bill_date\'><string>2015-05-22</string></var><var name=\'next_bill_date\'><string>2015-06-22</string></var><var name=\'bill_thru_date\'><string>2015-06-21</string></var><var name=\'bill_day\'><number>22</number></var><var name=\'recurring_billing_interval\'><number>1</number></var><var name=\'usage_billing_interval\'><number>1</number></var><var name=\'billing_ind\'><number>1</number></var><var name=\'display_ind\'><number>1</number></var><var name=\'rollover_months\'><null/></var><var name=\'rollover_plan_no\'><null/></var><var name=\'early_cancel_fee\'><null/></var><var name=\'early_cancel_min_months\'><null/></var><var name=\'suspension_period\'><null/></var><var name=\'initial_plan_status\'><null/></var><var name=\'rollover_plan_status\'><null/></var><var name=\'rollover_plan_status_duration\'><null/></var><var name=\'rollover_plan_status_uom_cd\'><null/></var><var name=\'init_free_period_duration\'><null/></var><var name=\'init_free_period_uom_cd\'><number>1</number></var><var name=\'plan_2_assign_on_susp\'><null/></var><var name=\'default_notify_method\'><null/></var><var name=\'prepaid_ind\'><number>0</number></var><var name=\'currency_cd\'><string>usd</string></var><var name=\'rate_schedule_no\'><number>11248897</number></var><var name=\'rate_schedule_name\'><string>Default-RSN USD</string></var><var name=\'rate_sched_is_default_ind\'><number>1</number></var><var name=\'supp_plan_ind\'><number>1</number></var><var name=\'plan_instance_status_cd\'><number>1</number></var><var name=\'plan_instance_status_label\'><string>Active</string></var><var name=\'plan_instance_status_date\'><string>2015-05-22</string></var><var name=\'dunning_state\'><null/></var><var name=\'dunning_step\'><null/></var><var name=\'dunning_degrade_date\'><null/></var><var name=\'plan_assignment_date\'><string>2015-05-22</string></var><var name=\'plan_deprovisioned_date\'><null/></var><var name=\'client_receipt_id\'><null/></var><var name=\'client_plan_id\'><string>Sub_Plan_E</string></var><var name=\'client_rollover_plan_id\'><null/></var><var name=\'client_plan_2_assign_on_susp\'><null/></var><var name=\'client_rate_schedule_id\'><string>Default-RSN_USD</string></var><var name=\'proration_invoice_timing_cd\'><string>I</string></var><var name=\'master_plan_instance_no\'><number>39206</number></var><var name=\'client_master_plan_instance_id\'><string>6619897482</string></var><var name=\'parent_plan_instance_no\'><number>39206</number></var><var name=\'client_parent_plan_instance_id\'><string>6619897482</string></var><var name=\'plan_services\'><array length=\'2\'><struct><var name=\'service_no\'><number>101</number></var><var name=\'service_desc\'><string>Activation Fee</string></var><var name=\'is_recurring_ind\'><number>0</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>1</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>0</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1001</string></var><var name=\'ledger_code\'><string>1001</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>101</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Setup Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>4000</number></var><var name=\'monthly_fee\'><null/></var><var name=\'client_rate_schedule_id\'><string>Default-RSN_USD</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct><struct><var name=\'service_no\'><number>10003126</number></var><var name=\'service_desc\'><string>Donation</string></var><var name=\'is_recurring_ind\'><number>1</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>1</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1002</string></var><var name=\'ledger_code\'><string>1002</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>10003126</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Recurring Flat Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>211</number></var><var name=\'monthly_fee\'><number>211</number></var><var name=\'client_rate_schedule_id\'><string>Default-RSN_USD</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct></array></var><var name=\'surcharges_all\'><null/></var><var name=\'product_fields\'><array length=\'4\'><struct><var name=\'field_name\'><string>PF1</string></var><var name=\'field_value\'><string>SubPF1</string></var></struct><struct><var name=\'field_name\'><string>PF2</string></var><var name=\'field_value\'><string>SubPF2</string></var></struct><struct><var name=\'field_name\'><string>SFDC_PlanName</string></var><var name=\'field_value\'><string>SubSFDC_PlanName</string></var></struct><struct><var name=\'field_name\'><string>PF_SAN</string></var><var name=\'field_value\'><string>SubPF_SAN</string></var></struct></array></var><var name=\'plan_instance_fields_detail\'><array length=\'4\'><struct><var name=\'field_name\'><string>PFI1</string></var><var name=\'field_value\'><string>Sub-PF 1</string></var></struct><struct><var name=\'field_name\'><string>PFI2</string></var><var name=\'field_value\'><string>Sub-PF 2</string></var></struct><struct><var name=\'field_name\'><string>PFI3</string></var><var name=\'field_value\'><string>Sub-PF 3</string></var></struct><struct><var name=\'field_name\'><string>PF_SAN_i</string></var><var name=\'field_value\'><string>SubPF_SAN_i</string></var></struct></array></var></struct><struct><var name=\'plan_no\'><number>10343176</number></var><var name=\'plan_name\'><string>Sub_Plan_G</string></var><var name=\'plan_desc\'><string>Sub_Plan_G</string></var><var name=\'plan_instance_no\'><number>39207</number></var><var name=\'client_plan_instance_id\'><string>8556193849</string></var><var name=\'plan_date\'><string>2015-05-22</string></var><var name=\'plan_units\'><number>1</number></var><var name=\'last_bill_date\'><string>2015-05-22</string></var><var name=\'next_bill_date\'><string>2015-06-22</string></var><var name=\'bill_thru_date\'><string>2015-06-21</string></var><var name=\'bill_day\'><number>22</number></var><var name=\'recurring_billing_interval\'><number>1</number></var><var name=\'usage_billing_interval\'><number>1</number></var><var name=\'billing_ind\'><number>1</number></var><var name=\'display_ind\'><number>1</number></var><var name=\'rollover_months\'><null/></var><var name=\'rollover_plan_no\'><null/></var><var name=\'early_cancel_fee\'><null/></var><var name=\'early_cancel_min_months\'><null/></var><var name=\'suspension_period\'><null/></var><var name=\'initial_plan_status\'><null/></var><var name=\'rollover_plan_status\'><null/></var><var name=\'rollover_plan_status_duration\'><null/></var><var name=\'rollover_plan_status_uom_cd\'><null/></var><var name=\'init_free_period_duration\'><null/></var><var name=\'init_free_period_uom_cd\'><number>1</number></var><var name=\'plan_2_assign_on_susp\'><null/></var><var name=\'default_notify_method\'><null/></var><var name=\'prepaid_ind\'><number>0</number></var><var name=\'currency_cd\'><string>usd</string></var><var name=\'rate_schedule_no\'><number>11248900</number></var><var name=\'rate_schedule_name\'><string>Default RSN--USD</string></var><var name=\'rate_sched_is_default_ind\'><number>1</number></var><var name=\'supp_plan_ind\'><number>1</number></var><var name=\'plan_instance_status_cd\'><number>1</number></var><var name=\'plan_instance_status_label\'><string>Active</string></var><var name=\'plan_instance_status_date\'><string>2015-05-22</string></var><var name=\'dunning_state\'><null/></var><var name=\'dunning_step\'><null/></var><var name=\'dunning_degrade_date\'><null/></var><var name=\'plan_assignment_date\'><string>2015-05-22</string></var><var name=\'plan_deprovisioned_date\'><null/></var><var name=\'client_receipt_id\'><null/></var><var name=\'client_plan_id\'><string>Sub_Plan_G</string></var><var name=\'client_rollover_plan_id\'><null/></var><var name=\'client_plan_2_assign_on_susp\'><null/></var><var name=\'client_rate_schedule_id\'><string>Default_RSN--USD</string></var><var name=\'proration_invoice_timing_cd\'><string>I</string></var><var name=\'master_plan_instance_no\'><number>39206</number></var><var name=\'client_master_plan_instance_id\'><string>6619897482</string></var><var name=\'parent_plan_instance_no\'><number>39206</number></var><var name=\'client_parent_plan_instance_id\'><string>6619897482</string></var><var name=\'plan_services\'><array length=\'2\'><struct><var name=\'service_no\'><number>0</number></var><var name=\'service_desc\'><string>Account Credit</string></var><var name=\'is_recurring_ind\'><number>0</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>0</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1000</string></var><var name=\'ledger_code\'><string>1000</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>0</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Recurring Flat Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>10000</number></var><var name=\'monthly_fee\'><null/></var><var name=\'client_rate_schedule_id\'><string>Default_RSN--USD</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct><struct><var name=\'service_no\'><number>10003126</number></var><var name=\'service_desc\'><string>Donation</string></var><var name=\'is_recurring_ind\'><number>1</number></var><var name=\'is_usage_based_ind\'><number>0</number></var><var name=\'usage_type\'><null/></var><var name=\'taxable_ind\'><number>0</number></var><var name=\'is_tax_ind\'><number>0</number></var><var name=\'is_arrears_ind\'><number>0</number></var><var name=\'is_setup_ind\'><number>0</number></var><var name=\'is_misc_ind\'><number>0</number></var><var name=\'is_donation_ind\'><number>1</number></var><var name=\'is_order_based_ind\'><number>0</number></var><var name=\'is_cancellation_ind\'><number>0</number></var><var name=\'coa_id\'><string>1002</string></var><var name=\'ledger_code\'><string>1002</string></var><var name=\'display_ind\'><number>1</number></var><var name=\'tiered_pricing_rule\'><number>1</number></var><var name=\'is_min_fee_ind\'><number>0</number></var><var name=\'client_service_id\'><string>10003126</string></var><var name=\'usage_type_cd\'><null/></var><var name=\'coa_code\'><string>Recurring Flat Fees COA Code</string></var><var name=\'fulfillment_based_ind\'><number>0</number></var><var name=\'plan_service_rates\'><array length=\'1\'><struct><var name=\'rate_seq_no\'><number>1</number></var><var name=\'from_unit\'><number>1</number></var><var name=\'to_unit\'><null/></var><var name=\'rate_per_unit\'><number>7778</number></var><var name=\'monthly_fee\'><number>7778</number></var><var name=\'client_rate_schedule_id\'><string>Default_RSN--USD</string></var><var name=\'rate_tier_description\'><null/></var></struct></array></var></struct></array></var><var name=\'surcharges_all\'><null/></var><var name=\'product_fields\'><array length=\'4\'><struct><var name=\'field_name\'><string>PF1</string></var><var name=\'field_value\'><string>Sub PF1</string></var></struct><struct><var name=\'field_name\'><string>PF2</string></var><var name=\'field_value\'><string>Sub PF2</string></var></struct><struct><var name=\'field_name\'><string>SFDC_PlanName</string></var><var name=\'field_value\'><string>SubSFDC_PlanName</string></var></struct><struct><var name=\'field_name\'><string>PF_SAN</string></var><var name=\'field_value\'><string>SubPF_SAN</string></var></struct></array></var><var name=\'plan_instance_fields_detail\'><array length=\'4\'><struct><var name=\'field_name\'><string>PFI1</string></var><var name=\'field_value\'><string>Sub PF 1</string></var></struct><struct><var name=\'field_name\'><string>PFI2</string></var><var name=\'field_value\'><string>Sub PF 2</string></var></struct><struct><var name=\'field_name\'><string>PFI3</string></var><var name=\'field_value\'><string>Sub PF 3</string></var></struct><struct><var name=\'field_name\'><string>PF_SAN_i</string></var><var name=\'field_value\'><string>Sub PF_SAN_i</string></var></struct></array></var></struct></array></var></struct></data></wddxPacket>');
            }
        
            System.debug(LoggingLevel.WARN, '********** Made callout to get_acct_plans_all from getAcctPlansAllEligibleForUpdate');
        
            
            // this method modifies a by reference
            //handleResult(a, result); // throws AriaAPIException
            handleResultEom(a, result);
        } catch (AriaAPIException e) {

            AriaUtil.logAriaError( 'Get Account Plans All EligibleForUpdate Error\nAria account number: ' + a.Aria_Id__c + '\nSalesforce account ID: ' + a.Id + '\n' +e.getMessage()+'\nOn line number: '+e.getLineNumber(), e.getTypeName() );
            
        } catch (Exception e) {
            // do something?
            System.debug(LoggingLevel.WARN, 'OOPS');
        }
        
        // call finish, which will upsert the results
        System.debug(LoggingLevel.WARN, '********** Calling finish method');
        finish();
    }
    
    public Account handleResultEom(Account a, WDDXData result) {
        
        System.debug('======WDDXData=result============='+result);
        
        // process result from callout attempt
        WDDXStruct mainStruct = (WDDXStruct)result.items[0];
         
        WDDXVariable errorCodeVar = mainStruct.get('error_code');
        Integer errorCodeNum = ((WDDXNumber)errorCodeVar.item).numValue.intValue();
        
        if(errorCodeNum != 0) {
            WDDXVariable errorMsgVar = mainStruct.get('error_msg');
            String errorMsgStr = 'Aria did not return an error message';
            
            if(errorMsgVar.item != WDDXNull.NIL)
                errorMsgStr = ((WDDXString)errorMsgVar.item).strValue;
                
            System.debug(LoggingLevel.WARN, '********** AriaIsAccountEligibleForUpdate failed with error_msg: ' + errorMsgStr);
            
            throw new AriaAPIException(errorMsgStr);
        }
        
        // if we get this far, the update was successful
        System.debug(LoggingLevel.WARN, '********** Got past error trap in handleResult');      
        
        
        /**** Extract AccountPlans returned from call ****/ 
        
        // This Map will tie each Account_Plan__c record to its Aria ClientPlan ID, since we don't store
        // that field directly on the AP record
        // only 'Active' and 'Active Pending' APs will make it into this list as we process the callout result
        Map<String, Account_Plan__c> returnedAPMap = new Map<String, Account_Plan__c>();
        
        // this is the main AP array of the callout result
        WDDXArray acctPlanArray = (WDDXArray)mainStruct.get('all_acct_plans_m').item;
        
        
        // build an Account_Plan__c record for each AP in callout result        
        String masterPlanId;
        List<String> suppPlanIds = new List<String>();
        WDDXStruct masterPlanStruct;
        List<WDDXStruct> suppPlanStructs = new List<WDDXStruct>();
        Datetime now = Datetime.now();
        Map<String, String> planIdToRateScheduleIdMap = new Map<String, String>();
        
        for (WDDXItem acctPlanItem : acctPlanArray.items) {
            WDDXStruct acctPlanStruct = (WDDXStruct)acctPlanItem;
            WDDXVariable suppPlanInd = acctPlanStruct.get('supp_plan_ind');
            
            // extract ClienPlan ID; coerce to String
            Double planIdNum = ((WDDXNumber)acctPlanStruct.get('plan_no').item).numValue;
            String planId = String.valueOf(planIdNum.intValue());
            
            // extract RateSchedule Aria ID; coerce to String
            // add to planIdToRateScheduleIdMap
            Double rateSchedIdNum = ((WDDXNumber)acctPlanStruct.get('rate_schedule_no').item).numValue;
            String rateSchedId = String.valueOf(rateSchedIdNum.intValue());
            
            
            // there should only be one Master
            if ( ((WDDXNumber)suppPlanInd.item).numValue == 0 ) {
                
                masterPlanId = planId;
                masterPlanStruct = acctPlanStruct;
                
                System.debug(LoggingLevel.WARN, '********** Master Plan ID from callout: ' + planId);
                //check if plan exists in SF
                
                List<Client_Plan__c> clientPlans;
                clientPlans = AriaPlanHelper.getClientPlans( ' WHERE Status__c= \'Active\' AND RecordType.Name = \'Master\' AND Aria_Id__c =' + '\'' + masterPlanId + '\'' + ' order by name' );
                if (clientPlans!=null && clientPlans.size()>0) {
                    isAccountWithValidMasterPlan=true;
                    break;
                    System.debug(LoggingLevel.WARN, '********** Master Client Plan AriaIsAccountEligibleForUpdate callout: ' + clientPlans);
                }
                
            } 
        }
        return a;
    }
    
    public Account handleResult(Account a, WDDXData result) {
        
        System.debug('======WDDXData=result============='+result);
        
        // process result from callout attempt
        WDDXStruct mainStruct = (WDDXStruct)result.items[0];
         
        WDDXVariable errorCodeVar = mainStruct.get('error_code');
        Integer errorCodeNum = ((WDDXNumber)errorCodeVar.item).numValue.intValue();
        
        if(errorCodeNum != 0) {
            WDDXVariable errorMsgVar = mainStruct.get('error_msg');
            String errorMsgStr = 'Aria did not return an error message';
            
            if(errorMsgVar.item != WDDXNull.NIL)
                errorMsgStr = ((WDDXString)errorMsgVar.item).strValue;
                
            System.debug(LoggingLevel.WARN, '********** AriaIsAccountEligibleForUpdate failed with error_msg: ' + errorMsgStr);
            
            throw new AriaAPIException(errorMsgStr);
        }
        
        // if we get this far, the update was successful
        System.debug(LoggingLevel.WARN, '********** Got past error trap in handleResult');      
        
        
        /**** Extract AccountPlans returned from call ****/ 
        
        // This Map will tie each Account_Plan__c record to its Aria ClientPlan ID, since we don't store
        // that field directly on the AP record
        // only 'Active' and 'Active Pending' APs will make it into this list as we process the callout result
        Map<String, Account_Plan__c> returnedAPMap = new Map<String, Account_Plan__c>();
        
        // this is the main AP array of the callout result
        WDDXArray acctPlanArray = (WDDXArray)mainStruct.get('all_acct_plans_m').item;
        
        
        // build an Account_Plan__c record for each AP in callout result        
        String masterPlanId;
        List<String> suppPlanIds = new List<String>();
        WDDXStruct masterPlanStruct;
        List<WDDXStruct> suppPlanStructs = new List<WDDXStruct>();
        Datetime now = Datetime.now();
        Map<String, String> planIdToRateScheduleIdMap = new Map<String, String>();
        
        for (WDDXItem acctPlanItem : acctPlanArray.items) {
            WDDXStruct acctPlanStruct = (WDDXStruct)acctPlanItem;
            WDDXVariable suppPlanInd = acctPlanStruct.get('supp_plan_ind');
            
            // extract ClienPlan ID; coerce to String
            Double planIdNum = ((WDDXNumber)acctPlanStruct.get('plan_no').item).numValue;
            String planId = String.valueOf(planIdNum.intValue());
            
            // extract RateSchedule Aria ID; coerce to String
            // add to planIdToRateScheduleIdMap
            Double rateSchedIdNum = ((WDDXNumber)acctPlanStruct.get('rate_schedule_no').item).numValue;
            String rateSchedId = String.valueOf(rateSchedIdNum.intValue());
            
            
            // there should only be one Master
            if ( ((WDDXNumber)suppPlanInd.item).numValue == 0 ) {
                
                masterPlanId = planId;
                masterPlanStruct = acctPlanStruct;
                
                System.debug(LoggingLevel.WARN, '********** Master Plan ID from callout: ' + planId);
                //check if plan exists in SF
                
                List<Client_Plan__c> clientPlans;
                clientPlans = AriaPlanHelper.getClientPlans( ' WHERE Status__c= \'Active\' AND RecordType.Name = \'Master\' AND Aria_Id__c =' + '\'' + masterPlanId + '\'' + ' order by name' );
                if (clientPlans!=null && clientPlans.size()>0) {
                    isAccountWithValidMasterPlan=true;
                    System.debug(LoggingLevel.WARN, '********** Master Client Plan AriaIsAccountEligibleForUpdate callout: ' + clientPlans);
                    break;
                }
                
            } 
        }
        return a;
    }
    
    
    public void finish() {
        
        
    }
}